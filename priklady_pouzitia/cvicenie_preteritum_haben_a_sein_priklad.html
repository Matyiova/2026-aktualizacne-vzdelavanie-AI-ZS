<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Préteritum haben a sein</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; font-weight: bold; background-color: #f9f9f9; color: #333; padding: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        h1 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 30px; }
        
        .question-block { display: none; margin-bottom: 20px; }
        .question-block.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .text-line, .fill-in-sentence { font-size: 1.3rem; margin: 15px 0; }
        .fill-in-sentence { line-height: 2.2; }

        .placeholder { display: inline-block; min-width: 50px; border-bottom: 2px dashed #007bff; color: #007bff; text-align: center; margin: 0 5px; cursor: default; font-size: 1.3rem; padding: 0 5px; }
        .placeholder.filled { border-bottom: 2px solid #000; color: #000; font-weight: bold; }

        .all-options-container { margin-top: 25px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .option-group { background: #f0f0f0; padding: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; border: 1px solid #ddd; }
        .option-btn { font-size: 1.1rem; padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; font-family: inherit; font-weight: bold; transition: 0.2s; }
        .option-btn:hover { background: #e2e6ea; }
        .option-btn.selected { background: #007bff; color: white; border-color: #0056b3; }
        .option-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .nav-buttons { margin: 20px 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; }
        .nav-btn { width: 35px; height: 35px; border: none; background: #ddd; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .nav-btn.active { background: #007bff; color: white; }
        .nav-btn.completed { background: #28a745; color: white; }
        .nav-btn.active.completed { background: #218838; border: 2px solid #000; }

        .controls { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .main-btn { padding: 12px 24px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 0 10px; }
        #nextBtn { background-color: #17a2b8; }
        #evaluateBtn { background-color: #28a745; }
        .main-btn:disabled { background-color: #ccc; cursor: default; }

        .results-box { display: none; margin-top: 30px; background: #e8f5e9; border: 1px solid #c8e6c9; padding: 20px; border-radius: 8px; text-align: left; }
        .symbol { font-size: 1.4rem; margin-left: 5px; }
        .correct-answer-symbol { color: green; }
        .incorrect-answer-symbol { color: red; }
        .print-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        
        @media print {
            .no-print { display: none !important; }
            .results-box { display: block !important; border: none; }
            body { background: white; }
            .container { box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Préteritum haben a sein</h1>
    
    <div class="no-print" style="text-align: left; margin-bottom: 20px;">
        <label>Meno žiaka: <input type="text" id="studentName" style="padding: 5px; font-size: 1rem;"></label>
    </div>

    <div id="exerciseArea"></div>

    <div class="nav-buttons no-print" id="navButtons"></div>

    <div class="controls no-print">
        <button id="nextBtn" class="main-btn">Ďalej</button>
        <button id="evaluateBtn" class="main-btn" style="display:none;">Vyhodnotiť</button>
    </div>

    <div id="summaryBox" class="results-box">
        <h2>Výsledky</h2>
        <p><strong>Žiak:</strong> <span id="resName"></span></p>
        <p><strong>Skóre:</strong> <span id="resScore"></span></p>
        <p><strong>Dátum:</strong> <span id="resDate"></span></p>
        <button class="print-btn" onclick="window.print()">Vytlačiť výsledky</button>
        <button class="print-btn" id="detailBtn">Zobraziť detail odpovedí</button>
    </div>
</div>

<script>
    // DATA
    let tasks = [[{"type":"fill","sentenceParts":["- Na, wie "," das Spiel? -###BR###- Schlecht. Ich "," Pech. -"],"optionGroups":[{"correct":"war","options":["war","hatte","waren","hatten"]},{"correct":"hatte","options":["hatte","war","hatten","waren"]}]}],[{"type":"fill","sentenceParts":["- Gehst du schon? -###BR###- Ja, ich muss los. Ich "," heute noch nicht zu Hause. -"],"optionGroups":[{"correct":"war","options":["war","hatte","waren","hatten"]}]}],[{"type":"fill","sentenceParts":["- Ihr "," gestern nicht beim Training. "," ihr keine Zeit? -###BR###- Doch, aber wir "," keine Lust. -"],"optionGroups":[{"correct":"wart","options":["wart","hattet","war","hatte"]},{"correct":"Hattet","options":["Hattet","Wart","Hatte","War"]},{"correct":"hatten","options":["hatten","waren","hattet","wart"]}]}],[{"type":"fill","sentenceParts":["- "," ihr heute Sport? -###BR###- Nein, wir "," Kunst. -"],"optionGroups":[{"correct":"Hattet","options":["Hattet","Wart","Hattest","Warst"]},{"correct":"hatten","options":["hatten","waren","hatte","war"]}]}],[{"type":"fill","sentenceParts":["- ","Tina und Leo auch in Köln? -###BR###- Nein, sie "," keine Zeit. -"],"optionGroups":[{"correct":"Waren","options":["Waren","Hatten","Wart","Hattet"]},{"correct":"hatten","options":["hatten","waren","hattet","wart"]}]}],[{"type":"fill","sentenceParts":["- Wie geht es Sarah? -###BR###- Nicht so gut.  Sie "," gestern einen Unfall. -"],"optionGroups":[{"correct":"hatte","options":["hatte","war","hatten","waren"]}]}],[{"type":"fill","sentenceParts":["- "," ihr schon mal in Wien? -###BR###- Nein, in Wien "," wir noch nicht. -"],"optionGroups":[{"correct":"Wart","options":["Wart","Hattet","War","Hatte"]},{"correct":"waren","options":["waren","hatten","war","hatte"]}]}]]; 
    const BREAK_MARKER = '###BR###';

    let currentIdx = 0;
    let userAnswers = []; // pole objektov pre odpovede
    let isFinished = false;

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function init() {
        // Zamiešanie úloh pri štarte
        shuffleArray(tasks);
        tasks.forEach((_, i) => userAnswers[i] = {});
        
        renderAllTasks();
        renderNav();
        showTask(0);
        
        document.getElementById('nextBtn').addEventListener('click', goNext);
        document.getElementById('evaluateBtn').addEventListener('click', evaluate);
        document.getElementById('detailBtn').addEventListener('click', showDetails);
    }

    function renderAllTasks() {
        const area = document.getElementById('exerciseArea');
        
        tasks.forEach((lines, tIndex) => {
            const div = document.createElement('div');
            div.className = 'question-block';
            div.id = 'task-' + tIndex;

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'all-options-container';

            lines.forEach((line, lIndex) => {
                if (line.type === 'text') {
                    const p = document.createElement('p');
                    p.className = 'text-line';
                    p.innerHTML = line.content.split(BREAK_MARKER).join('<br>');
                    div.appendChild(p);
                } 
                else if (line.type === 'fill') {
                    const p = document.createElement('p');
                    p.className = 'fill-in-sentence';
                    
                    line.sentenceParts.forEach((part, gIndex) => {
                        const textSegments = part.split(BREAK_MARKER);
                        textSegments.forEach((seg, segIdx) => {
                            p.appendChild(document.createTextNode(seg));
                            if (segIdx < textSegments.length - 1) {
                                p.appendChild(document.createElement('br'));
                            }
                        });

                        if (gIndex < line.optionGroups.length) {
                            const gapKey = lIndex + '-' + gIndex;
                            
                            const span = document.createElement('span');
                            span.className = 'placeholder';
                            span.textContent = '...';
                            span.id = 'ph-' + tIndex + '-' + gapKey;
                            p.appendChild(span);

                            const group = document.createElement('div');
                            group.className = 'option-group';
                            
                            const opts = [...line.optionGroups[gIndex].options];
                            opts.sort(() => Math.random() - 0.5);

                            opts.forEach(opt => {
                                const btn = document.createElement('button');
                                btn.className = 'option-btn';
                                btn.textContent = opt;
                                btn.onclick = () => selectOption(tIndex, gapKey, opt, btn, line.optionGroups[gIndex].correct);
                                group.appendChild(btn);
                            });
                            optionsContainer.appendChild(group);
                        }
                    });
                    div.appendChild(p);
                }
            });
            div.appendChild(optionsContainer);
            area.appendChild(div);
        });
    }

    function selectOption(tIdx, gapKey, text, btn, correctVal) {
        if (isFinished) return;

        userAnswers[tIdx][gapKey] = text;

        const ph = document.getElementById('ph-' + tIdx + '-' + gapKey);
        ph.textContent = text;
        ph.classList.add('filled');

        const group = btn.parentElement;
        group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');

        updateNav();
    }

    function showTask(idx) {
        document.querySelectorAll('.question-block').forEach(b => b.classList.remove('active'));
        document.getElementById('task-' + idx).classList.add('active');
        currentIdx = idx;
        
        const next = document.getElementById('nextBtn');
        const evalBtn = document.getElementById('evaluateBtn');
        
        if (idx === tasks.length - 1) {
            next.style.display = 'none';
            evalBtn.style.display = 'inline-block';
        } else {
            next.style.display = 'inline-block';
            next.innerText = 'Ďalej';
            evalBtn.style.display = 'none';
        }
        updateNav();
    }

    function goNext() {
        if (currentIdx < tasks.length - 1) showTask(currentIdx + 1);
    }

    function renderNav() {
        const c = document.getElementById('navButtons');
        c.innerHTML = '';
        tasks.forEach((_, i) => {
            const b = document.createElement('button');
            b.className = 'nav-btn';
            b.innerText = i + 1;
            b.onclick = () => showTask(i);
            c.appendChild(b);
        });
    }

    function updateNav() {
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach((b, i) => {
            b.className = 'nav-btn';
            if (i === currentIdx) b.classList.add('active');
            if (Object.keys(userAnswers[i]).length > 0) b.classList.add('completed');
        });
    }

    function evaluate() {
        isFinished = true;
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('evaluateBtn').style.display = 'none';
        
        let correct = 0;
        let total = 0;

        tasks.forEach((lines, tIdx) => {
            lines.forEach((line, lIdx) => {
                if (line.type === 'fill') {
                    line.sentenceParts.forEach((part, gIndex) => {
                        if (gIndex < line.optionGroups.length) {
                            total++;
                            const gapKey = lIdx + '-' + gIndex;
                            const userAns = userAnswers[tIdx][gapKey];
                            const corrAns = line.optionGroups[gIndex].correct;
                            const isCorr = (userAns === corrAns);
                            
                            if (isCorr) correct++;

                            // Vizuálna kontrola v úlohe
                            const ph = document.getElementById('ph-' + tIdx + '-' + gapKey);
                            const mark = document.createElement('span');
                            mark.className = 'symbol ' + (isCorr ? 'correct-answer-symbol' : 'incorrect-answer-symbol');
                            mark.innerHTML = isCorr ? '✔' : '❌';
                            ph.parentNode.insertBefore(mark, ph.nextSibling);
                        }
                    });
                }
            });
        });

        const percent = total > 0 ? Math.round((correct / total) * 100) : 0;
        document.getElementById('resName').innerText = document.getElementById('studentName').value || "Anonym";
        document.getElementById('resScore').innerText = `${correct} / ${total} (${percent}%)`;
        document.getElementById('resDate').innerText = new Date().toLocaleString('sk-SK');
        document.getElementById('summaryBox').style.display = 'block';

        document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
    }

    // *** NOVÁ FUNKCIA PRE DETAILNÉ VÝSLEDKY ***
    function showDetails() {
        const win = window.open('', '_blank');
        let tableRows = '';

        tasks.forEach((lines, tIdx) => {
            lines.forEach((line, lIdx) => {
                // 1. Ak je to obyčajný text, zobrazíme ho kurzívou ako kontext
                if (line.type === 'text') {
                    const textContent = line.content.split(BREAK_MARKER).join('<br>');
                    tableRows += `
                        <tr><td colspan="2" style="background:#fcfcfc; color:#555; font-style:italic; font-size:0.9rem; border-bottom:1px solid #eee; padding:5px 10px;">${textContent}</td></tr>
                    `;
                }
                // 2. Ak je to doplňovačka
                if (line.type === 'fill') {
                    let sentenceHtml = '';
                    let evaluationHtml = '';

                    line.sentenceParts.forEach((part, gIndex) => {
                        // Pridáme text pred medzerou
                        sentenceHtml += part.split(BREAK_MARKER).join('<br>');

                        if (gIndex < line.optionGroups.length) {
                            const gapKey = lIdx + '-' + gIndex;
                            const userAns = userAnswers[tIdx][gapKey];
                            const correctAns = line.optionGroups[gIndex].correct;
                            const isFilled = (userAns !== undefined);
                            const isCorrect = isFilled && (userAns === correctAns);

                            // STĹPEC 1: Veta s odpoveďou
                            let displayAns = isFilled ? userAns : "____";
                            let color = isCorrect ? 'green' : (isFilled ? 'red' : '#999');
                            
                            sentenceHtml += `<strong style="color:${color}; border-bottom:1px solid ${color}; padding:0 2px;">${displayAns}</strong>`;

                            // STĹPEC 2: Vyhodnotenie
                            if (isCorrect) {
                                evaluationHtml += `<div style="margin-bottom:5px; color:green;">✔ Správne</div>`;
                            } else {
                                evaluationHtml += `<div style="margin-bottom:5px; color:red;">
                                    ❌ <strong>${displayAns}</strong><br>
                                    <span style="color:#333; font-size:0.9em;">Správne má byť: <strong>${correctAns}</strong></span>
                                </div>`;
                            }
                            
                            // Oddeľovač ak je viac medzier v jednej vete
                            if (gIndex < line.optionGroups.length - 1) {
                                evaluationHtml += '<hr style="border:0; border-top:1px dashed #ccc; margin:5px 0;">';
                            }
                        }
                    });

                    tableRows += `
                        <tr>
                            <td style="vertical-align:top; padding:10px; border-bottom:1px solid #ccc; width:60%;">${sentenceHtml}</td>
                            <td style="vertical-align:top; padding:10px; border-bottom:1px solid #ccc;">${evaluationHtml}</td>
                        </tr>
                    `;
                }
            });
        });

        const html = `<!DOCTYPE html>
        <html><head><title>Detailné výsledky</title>
        <style>
            body{font-family:sans-serif; padding:20px;}
            table{width:100%; border-collapse:collapse; margin-top:20px;}
            th{background:#eee; text-align:left; padding:10px; border:1px solid #999;}
            td{border:1px solid #ccc;}
            h2{color:#0056b3;}
        </style></head>
        <body>
            <h2>Detailné výsledky: ${document.getElementById('studentName').value}</h2>
            <p>Dátum: ${new Date().toLocaleString('sk-SK')}</p>
            <table>
                <thead>
                    <tr>
                        <th>Veta s doplnenou odpoveďou</th>
                        <th>Vyhodnotenie</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
            <br><button onclick="window.print()" style="padding:10px 20px; font-size:16px;">Vytlačiť výsledky</button>
        </body></html>`;
        
        win.document.write(html);
        win.document.close();
    }

    init();
</script>
<div class="no-print" style="margin-top: 50px; text-align: center; font-size: 0.8rem; color: #aaa;">
    <b>Spracovala pomocou UI:</b> Mgr. Erika Matyiová (2025)
</div>
</body>
</html>