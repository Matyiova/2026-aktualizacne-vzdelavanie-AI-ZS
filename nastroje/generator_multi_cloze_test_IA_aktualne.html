<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <title>Interakt√≠vny Cloze Test s klikateƒænou interpunkciou a exportom</title>
  <style>
    body { font-family: Courier bold, monospace; margin: 20px; font-size: 100%; }
    h1 { margin-top: 0; }

    .panel { margin: 12px 0; }
    .hint { color: #666; font-size: 0.92em; }

    textarea {
      width: 100%;
      min-height: 250px;
      font-family: monospace;
	  font-size: 130%;
      padding: 8px;
      box-sizing: border-box;
    }

    input[type="text"] { padding: 6px; width: 320px; }

    button {
      margin-right: 8px;
      padding: 6px 10px;
      font-size: 1em;
      cursor: pointer;
    }

    .word, .punc { cursor: pointer; padding: 0 2px; border-radius: 3px; }
    .word.marked, .punc.marked { background: #ffe58f; }

    .gap {
      display: inline-block;
      cursor: pointer;
      margin: 0 4px;
      padding: 1px 2px;
      border-radius: 4px;
      font-family: monospace;
	  font-size: 130%;
      letter-spacing: 0.3em;
      color: #0b3d91;
      font-weight: bold;
    }
    .gap.selected   { background-color: #cceeff; font-size: 130%; }
    .gap.correct    { background: #e6ffed; border: 1px solid #34c759; color: #065f46; font-size: 130%; }
    .gap.incorrect  { background: #ffecec; border: 1px solid #ff3b30; color: #7a0010; font-size: 130%; }

    .choice {
      display: inline-block;
      margin: 5px 6px 0 0;
      padding: 5px 10px;
      background-color: #eee;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }
    .choice:hover { background-color: #ddd; }

    .result { margin-top: 16px; font-weight: bold; }
    #solutionsArea h3 { margin: 8px 0; }
    #solutionsArea ol { margin: 6px 0 0 20px; }

    #toolbar button {
      margin-right: 8px;
      padding: 4px 8px;
      font-size: 1em;
      cursor: pointer;
    }

    /* zachov√°vanie viacn√°sobn√Ωch medzier a zalamovanie */
    #testArea {
      white-space: pre-wrap;
      outline: 1px solid #ccc;
      padding: 8px;
      min-height: 120px;
    }

    /* Viac√∫lohov√© rozlo≈æenie */
    .taskBlock { border: 1px solid #ccc; padding: 10px; margin: 15px 0; }
    .taskHeader { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .taskHeader h3 { margin: 0 8px 0 0; }
    .clickable-block, .testContent { white-space: pre-wrap; }
    .testContent { outline: none; padding: 6px 0; }

    .summary { margin-top: 20px; font-size: 1.05em; font-weight: bold; }
  </style>
</head>
<body>

  <h1>üß© Interakt√≠vny Cloze Test s klikateƒænou interpunkciou</h1>
<p><b>Postup na tvorbu jedno√∫lohov√©ho Cloze testu:</b><br>
1. Zadajte do vstupn√©ho poƒæa text, z ktor√©ho chcete vytvori≈• interakt√≠vny Cloze test.<br>
2. Kliknite na tlaƒçidlo "Oznaƒçi≈• slov√° kliknut√≠m".<br>
3. Kliknite na jednotliv√© slov√°, ktor√© chcete, aby ≈æiak doplnil (zafarbia sa na ≈ælto).<br>
4. Kliknite na tlaƒçidlo "Generova≈• test (jedna √∫loha)".<br>
5. V dolnej ƒçasti str√°nky kliknete na tlaƒçidlo "Stiahnu≈• (aktu√°lny jedno√∫lohov√Ω test)".</p>

<p><b>Postup na tvorbu viac√∫lohov√©ho Cloze testu:</b><br>
1. Zadajte do vstupn√©ho poƒæa text, z ktor√©ho chcete vytvori≈• interakt√≠vny Cloze test.<br>
2. Medzi jednotliv√© √∫lohy vlo≈æte 2 pr√°zdne riadky.<br>
3. Kliknite na tlaƒçidlo "Rozdeli≈• na √∫lohy".<br>
4. Pri ka≈ædej √∫lohe kliknite na tlaƒçidlo "Oznaƒçi≈• slov√° kliknut√≠m".<br>
5. Kliknite na jednotliv√© slov√°, ktor√© chcete, aby ≈æiak doplnil (zafarbia sa na ≈ælto).<br>
4. Pri ka≈ædej √∫lohe kliknite na tlaƒçidlo "Generova≈• test".<br>
5. V dolnej ƒçasti str√°nky kliknete na tlaƒçidlo "Stiahnu≈• (v≈°etky vygenerovan√© √∫lohy)".</p>
  <div class="panel">
    <label><b>N√°zov testu:</b> <input id="testTitle" type="text" placeholder="Zadajte n√°zov testu"></label>
  </div>

  <div class="panel">
  <p><b>Vstupn√© pole:</b></p>
    <textarea id="inputText" placeholder="Sem vlo≈æte text, ktor√Ω nesk√¥r uprav√≠te.&#10;Viacer√© √∫lohy oddeƒæte dvoma pr√°zdnymi riadkami."></textarea>
  </div>

  <!-- Whitespace-cleaning controls -->
  <div class="panel">
    <button id="btnClean">üßº Vyƒçisti≈• medzery</button>
    <button id="btnFixCommas">üîç Skontrolova≈• ƒçiarky</button>
    <button id="btnFixPunctuation">üîé Skontrolova≈• interpunkciu</button>
    <button id="btnFixQuotes">üí¨ Skontrolova≈• √∫vodzovky</button>
    <button id="btnCopy">üìã Kop√≠rova≈• do schr√°nky</button>
  </div>

  <!-- Jedno-√∫lohov√Ω re≈æim (ponechan√Ω) -->
  <div class="panel">
    <button id="btnPrepare">Oznaƒçi≈• slov√° kliknut√≠m</button>
    <button id="btnGenerate">Generova≈• test (jedna √∫loha)</button><br><br>
    <span class="hint">
      Tip: Kliknite na slovo alebo interpunkciu (.,?!), ktor√∫ chcete skry≈•. Tab vlo≈æ√≠ 4 medzery, dvojklik vr√°ti odpoveƒè sp√§≈•.
    </span>
  </div>

  <div id="clickableText" class="panel"></div>

  <div id="toolbar" class="panel">
    <button onclick="applyFormat('bold')"><b>B</b></button>
  </div>

  <div class="panel areas">
    <div id="testArea" contenteditable="true" class="panel"></div>
    <div id="choicesArea" class="panel"></div>
  </div>

  <div id="result" class="result"></div>
  <div id="solutionsArea" class="panel"></div>

  <div class="panel">
    <button id="btnEvaluate">Vyhodnoti≈• (jedna √∫loha)</button>
  </div>

  <hr>
  

  <!-- Viac√∫lohov√Ω re≈æim -->
  <div class="panel">
    <button id="btnSplit">üîÄ Rozdeli≈• na √∫lohy</button>
    <button id="btnEvaluateAll">üìä Vyhodnoti≈• v≈°etky</button>
    <span class="hint">Bloky oddeƒæte dvoma pr√°zdnymi riadkami. Ka≈æd√° √∫loha m√° vlastn√© ovl√°danie a vyhodnotenie.</span>
  </div>

  <div class="panel">
    <button id="btnDownloadSingle">‚¨áÔ∏è Stiahnu≈• (aktu√°lny jedno√∫lohov√Ω test)</button>
    <button id="btnDownloadAll">‚¨áÔ∏è Stiahnu≈• (v≈°etky vygenerovan√© √∫lohy)</button>
    <span class="hint">Export vytvor√≠ samostatn√© HTML s√∫bory.</span>
  </div>

  <div id="tasksContainer"></div>
  <div id="summary" class="summary"></div>

  <script>
    // Utility
    function codePointLen(s){ return Array.from(s||'').length; }
    function shuffle(a){ var t=a.slice(); for(var i=t.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)); var tmp=t[i]; t[i]=t[j]; t[j]=tmp;} return t; }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function tokenize(text){
      var re = /([A-Za-z√Å√Ñƒåƒé√â√çƒπƒΩ≈á√ì√î≈î≈†≈§√ö√ù≈Ω√°√§ƒçƒè√©√≠ƒ∫ƒæ≈à√≥√¥≈ï≈°≈•√∫√Ω≈æ√ú√ñ≈ê≈∞√º√∂≈ë≈±√ü·∫û]+(?:-[A-Za-z√Å√Ñƒåƒé√â√çƒπƒΩ≈á√ì√î≈î≈†≈§√ö√ù≈Ω√°√§ƒçƒè√©√≠ƒ∫ƒæ≈à√≥√¥≈ï≈°≈•√∫√Ω≈æ√ú√ñ≈ê≈∞√º√∂≈ë≈±√ü·∫û]+)*)|(\s+)|([.,!?])/gu;
      var out=[],m;
      while((m=re.exec(text))!==null){
        if(m[1]) out.push({t:m[1],type:'word'});
        else if(m[2]) out.push({t:m[2],type:'space'});
        else out.push({t:m[3],type:'punc'});
      }
      return out.length?out:[{t:text,type:'word'}];
    }

    // Jedno-√∫lohov√© premenn√©
    var tokens=[], hiddenSet=new Set(), correctAnswers={}, userAnswers={}, selectedGapEl=null;

    // Jedno-√∫lohov√© ovl√°danie
    document.getElementById('btnPrepare').onclick = function(){
      hiddenSet.clear(); tokens = tokenize(document.getElementById('inputText').value);
      document.getElementById('clickableText').innerHTML=''; document.getElementById('result').textContent=''; document.getElementById('solutionsArea').innerHTML='';
      userAnswers={};
      var frag=document.createDocumentFragment();
      tokens.forEach(function(tok,idx){
        if(tok.type==='word' || tok.type==='punc'){
          var sp=document.createElement('span'); sp.textContent=tok.t; sp.className=(tok.type==='word'?'word':'punc');
          sp.dataset.idx=idx; sp.onclick=function(){ if(hiddenSet.has(idx)){ hiddenSet.delete(idx); sp.classList.remove('marked'); } else { hiddenSet.add(idx); sp.classList.add('marked'); } };
          frag.appendChild(sp);
        } else frag.appendChild(document.createTextNode(tok.t));
      });
      var ct=document.getElementById('clickableText'); ct.innerHTML=''; ct.appendChild(frag); ct.classList.add('clickable-block');
    };

    document.getElementById('btnGenerate').onclick = function(){
      if(!tokens.length){ alert('Najprv kliknite na ‚ÄûOznaƒçi≈• slov√° kliknut√≠m‚Äú.'); return; }
      var testArea=document.getElementById('testArea'), choicesArea=document.getElementById('choicesArea');
      testArea.innerHTML=''; choicesArea.innerHTML=''; document.getElementById('result').textContent=''; document.getElementById('solutionsArea').innerHTML='';
      correctAnswers={}; userAnswers={}; selectedGapEl=null;

      var h3c=document.createElement('h3'); h3c.textContent='Slov√° na doplnenie';
      choicesArea.appendChild(h3c);

      var counter=1, missing=[];
      tokens.forEach(function(tok,idx){
        if((tok.type==='word' || tok.type==='punc') && hiddenSet.has(idx)){
          var correct=tok.t, clen=codePointLen(correct);
          var gap=document.createElement('span'); gap.className='gap'; gap.dataset.gap=counter; gap.dataset.correctLen=clen; gap.dataset.current='';
          gap.textContent = '_'.repeat(clen)+'('+counter+')';
          correctAnswers[counter]=correct;
          testArea.appendChild(gap);
          missing.push(correct);
          counter++;
        } else {
          testArea.appendChild(document.createTextNode(tok.t));
        }
      });
      shuffle(missing).forEach(function(w){ var c=document.createElement('span'); c.className='choice'; c.textContent=w; choicesArea.appendChild(c); });
    };

    document.getElementById('testArea').onclick = function(e){
      var g=e.target.closest('.gap'); if(!g) return; if(selectedGapEl) selectedGapEl.classList.remove('selected'); selectedGapEl=g; g.classList.add('selected');
    };
    document.getElementById('testArea').ondblclick = function(e){
      var g=e.target.closest('.gap'); if(!g) return; var num=g.dataset.gap;
      if(userAnswers[num]){ var back=document.createElement('span'); back.className='choice'; back.textContent=userAnswers[num]; document.getElementById('choicesArea').appendChild(back); delete userAnswers[num]; }
      var clen=Number(g.dataset.correctLen); g.textContent = '_'.repeat(clen)+'('+num+')'; g.classList.remove('selected','correct','incorrect'); selectedGapEl=null; g.dataset.current='';
    };
    document.getElementById('choicesArea').onclick = function(e){
      var c=e.target.closest('.choice'); if(!c) return; if(!selectedGapEl){ alert('Najprv kliknite na medzeru.'); return; }
      var num=selectedGapEl.dataset.gap;
      if(userAnswers[num]){ var back=document.createElement('span'); back.className='choice'; back.textContent=userAnswers[num]; document.getElementById('choicesArea').appendChild(back); }
      selectedGapEl.textContent = c.textContent + '('+num+')'; userAnswers[num]=c.textContent; selectedGapEl.dataset.current=c.textContent;
      c.remove(); selectedGapEl.classList.remove('selected'); selectedGapEl=null;
    };

    document.getElementById('btnEvaluate').onclick = function(){
      var total = Object.keys(correctAnswers).length; if(total===0){ document.getElementById('result').textContent='Najprv vygenerujte test.'; return; }
      document.querySelectorAll('.gap').forEach(function(g){
        g.classList.remove('correct','incorrect');
        var num=g.dataset.gap; var correct=correctAnswers[num]||''; var clen=Number(g.dataset.correctLen);
        var user=userAnswers[num]||''; var miss=Math.max(0, clen - codePointLen(user));
        g.textContent=(user||'')+'_'.repeat(miss)+'('+num+')'; if(user===correct) g.classList.add('correct'); else g.classList.add('incorrect');
      });
      var ok=document.querySelectorAll('.gap.correct').length; var pct=Math.round(ok/(total||1)*100);
      document.getElementById('result').textContent='‚úÖ Spr√°vne: '+ok+'/'+total+' ('+pct+'%)';
      var solH3=document.createElement('h3'); solH3.textContent='Spr√°vne odpovede:'; var ol=document.createElement('ol');
      Object.keys(correctAnswers).map(Number).sort().forEach(function(n){ var li=document.createElement('li'); li.textContent=correctAnswers[n]; ol.appendChild(li); });
      var solArea=document.getElementById('solutionsArea'); solArea.innerHTML=''; solArea.appendChild(solH3); solArea.appendChild(ol);
    };

    function applyFormat(cmd){ document.execCommand(cmd,false,null); document.getElementById('testArea').focus(); }
    document.getElementById('testArea').addEventListener('keydown', function(e){ if(e.key==='Tab'){ e.preventDefault(); var sel=window.getSelection(); if(!sel.rangeCount) return; var range=sel.getRangeAt(0); var spaces=document.createTextNode('    '); range.insertNode(spaces); range.setStartAfter(spaces); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); } });

    // Viac√∫lohov√Ω re≈æim
    var tasks = []; // {id, blockText, tokens, hiddenSet, correctAnswers, userAnswers, selectedGap, score}

    document.getElementById('btnSplit').onclick = function(){
      var container=document.getElementById('tasksContainer'); container.innerHTML=''; document.getElementById('summary').textContent=''; tasks=[];
      var input=(document.getElementById('inputText').value||'').replace(/\r\n?/g,'\n');
      // presn√© delenie na bloky: dva pr√°zdne riadky (teda aspo≈à tri \n medzi blokmi)
      var blocks=input.split(/\n\s*\n\s*\n/).map(function(b){ return b; }).filter(function(b){ return b.trim().length>0; });
      if(!blocks.length){ alert('Neboli n√°jden√© ≈æiadne bloky. Oddelte √∫lohy dvoma pr√°zdnymi riadkami.'); return; }
      blocks.forEach(function(block,i){
        var t = { id:i+1, blockText:block, tokens:tokenize(block), hiddenSet:new Set(), correctAnswers:{}, userAnswers:{}, selectedGap:null, score:null };
        tasks.push(t); renderTask(t);
      });
    };

    function renderTask(task){
      var container=document.getElementById('tasksContainer');
      var div=document.createElement('div'); div.className='taskBlock'; div.id='task'+task.id;
      div.innerHTML = '<div class="taskHeader"><h3>√öloha '+task.id+'</h3><button class="btnPrepare">Oznaƒçi≈• slov√°</button><button class="btnGenerate">Generova≈• test</button><button class="btnEvaluate">Vyhodnoti≈•</button></div><div class="clickable"></div><div class="testArea"><div class="testContent"></div></div><div class="choicesArea"></div><div class="result"></div><div class="solutions"></div>';
      container.appendChild(div);
      var clickEl=div.querySelector('.clickable'); clickEl.textContent=task.blockText; clickEl.classList.add('clickable-block');
      div.querySelector('.btnPrepare').onclick=function(){ prepareTask(task,div); };
      div.querySelector('.btnGenerate').onclick=function(){ generateTask(task,div); };
      div.querySelector('.btnEvaluate').onclick=function(){ evaluateTask(task,div); };
    }

    function prepareTask(task,div){
      task.hiddenSet.clear(); task.userAnswers={};
      var frag=document.createDocumentFragment();
      task.tokens.forEach(function(tok,idx){
        if(tok.type==='word' || tok.type==='punc'){
          var sp=document.createElement('span'); sp.textContent=tok.t; sp.className=(tok.type==='word'?'word':'punc');
          sp.dataset.idx=idx; sp.onclick=function(){ if(task.hiddenSet.has(idx)){ task.hiddenSet.delete(idx); sp.classList.remove('marked'); } else { task.hiddenSet.add(idx); sp.classList.add('marked'); } };
          frag.appendChild(sp);
        } else frag.appendChild(document.createTextNode(tok.t));
      });
      var clickEl=div.querySelector('.clickable'); clickEl.innerHTML=''; clickEl.appendChild(frag); clickEl.classList.add('clickable-block');
      div.querySelector('.testContent').innerHTML=''; div.querySelector('.choicesArea').innerHTML=''; div.querySelector('.result').textContent=''; div.querySelector('.solutions').innerHTML='';
    }

    function generateTask(task,div){
      var testContent = div.querySelector('.testContent'), choicesArea = div.querySelector('.choicesArea');
      testContent.innerHTML = ''; choicesArea.innerHTML = '<h4>Slov√° na doplnenie</h4>';
      task.correctAnswers={}; task.userAnswers={}; task.selectedGap=null;
      var counter=1, missing=[];
      task.tokens.forEach(function(tok,idx){
        if((tok.type==='word' || tok.type==='punc') && task.hiddenSet.has(idx)){
          var correct=tok.t; var clen=codePointLen(correct);
          var gap=document.createElement('span'); gap.className='gap'; gap.dataset.gap=counter; gap.dataset.correctLen=clen; gap.dataset.current='';
          gap.textContent = '_'.repeat(clen)+'('+counter+')';
          gap.onclick=function(){ if(task.selectedGap) task.selectedGap.classList.remove('selected'); task.selectedGap=gap; gap.classList.add('selected'); };
          gap.ondblclick=function(){ var num=gap.dataset.gap; if(task.userAnswers[num]){ var back=document.createElement('span'); back.className='choice'; back.textContent=task.userAnswers[num]; choicesArea.appendChild(back); delete task.userAnswers[num]; } gap.textContent='_'.repeat(clen)+'('+num+')'; gap.classList.remove('selected','correct','incorrect'); task.selectedGap=null; gap.dataset.current=''; };
          testContent.appendChild(gap); task.correctAnswers[counter]=correct; missing.push(correct); counter++;
        } else testContent.appendChild(document.createTextNode(tok.t));
      });
      shuffle(missing).forEach(function(w){
        var c=document.createElement('span'); c.className='choice'; c.textContent=w;
        c.onclick=function(){
          if(!task.selectedGap){ alert('Najprv kliknite na medzeru.'); return; }
          var num=task.selectedGap.dataset.gap;
          if(task.userAnswers[num]){ var back=document.createElement('span'); back.className='choice'; back.textContent=task.userAnswers[num]; choicesArea.appendChild(back); }
          task.selectedGap.textContent=c.textContent+'('+num+')'; task.userAnswers[num]=c.textContent; task.selectedGap.dataset.current=c.textContent;
          c.remove(); task.selectedGap.classList.remove('selected'); task.selectedGap=null;
        };
        choicesArea.appendChild(c);
      });
      div.querySelector('.result').textContent=''; div.querySelector('.solutions').innerHTML='';
    }

    function evaluateTask(task,div){
      var total = Object.keys(task.correctAnswers).length; if(total===0){ div.querySelector('.result').textContent='Najprv generujte test.'; return; }
      div.querySelectorAll('.testContent .gap').forEach(function(g){
        g.classList.remove('correct','incorrect');
        var num=g.dataset.gap; var correct=task.correctAnswers[num]||''; var clen=Number(g.dataset.correctLen);
        var user=task.userAnswers[num]||''; var miss=Math.max(0, clen - codePointLen(user));
        g.textContent=(user||'')+'_'.repeat(miss)+'('+num+')'; if(user===correct) g.classList.add('correct'); else g.classList.add('incorrect');
      });
      var ok = div.querySelectorAll('.testContent .gap.correct').length; var pct = Math.round(ok/(total||1)*100);
      div.querySelector('.result').textContent='‚úÖ Spr√°vne: '+ok+'/'+total+' ('+pct+'%)';
      var sol = div.querySelector('.solutions'); sol.innerHTML='<h4>Spr√°vne odpovede:</h4>'; var ol=document.createElement('ol');
      Object.keys(task.correctAnswers).map(Number).sort().forEach(function(n){ var li=document.createElement('li'); li.textContent=task.correctAnswers[n]; ol.appendChild(li); });
      sol.appendChild(ol); task.score={ok:ok,total:total};
    }

    document.getElementById('btnEvaluateAll').onclick = function(){
      var sumOk=0,sumTotal=0;
      tasks.forEach(function(t){ if(t.score){ sumOk+=t.score.ok; sumTotal+=t.score.total; } });
      if(sumTotal===0){ document.getElementById('summary').textContent='Najprv vyhodno≈•te jednotliv√© √∫lohy.'; return; }
      var pct=Math.round(sumOk/sumTotal*100);
      document.getElementById('summary').textContent='üìä Celkov√Ω v√Ωsledok: '+sumOk+'/'+sumTotal+' ('+pct+'%)';
    };

    // Export (download)
function buildStandaloneHTML(title, sections){
  var head = '<!doctype html><html lang="sk"><head><meta charset="utf-8"><title>' + escapeHtml(title) + '</title><style>' +
    'body{font-family:Courier bold, monospace;margin:20px;font-size:115%;line-height:1.6}h1{margin-top:0}' +
    '.gap{display:inline-block;margin:0 2px;padding:0 2px;border-radius:2px;font-family:monospace;letter-spacing:0.3em;color:#0b3d91;font-size:130%;font-weight:bold;cursor:pointer}' +
    '.gap.selected{background:#cceeff}' +
    '.gap.correct{background:#e6ffed;border:1px solid #34c759;color:#065f46;font-size:130%}' +
    '.gap.incorrect{background:#ffecec;border:1px solid #ff3b30;color:#7a0010;font-size:130%}' +
    '.choice{display:inline-block;margin:5px 6px 0 0;padding:5px 10px;background:#eee;border-radius:6px;cursor:pointer}' +
    '.choice:hover{background:#ddd}' +
    '.test-block{border:1px solid #ddd;padding:10px;margin-bottom:14px;white-space:pre-wrap}' +
    '.meta{margin-top:12px}' +
    '.choices-label{margin-top:12px;font-weight:bold}' +
    '</style></head><body>';

  var body = '<h1>' + escapeHtml(title) + '</h1>' +
    '<p style="font-weight: bold;">Klikni na miesto, kde nieƒço ch√Ωba a potom klikni na niektor√∫ z polo≈æiek.<br>Ak si to rozmysl√≠≈°, klikni na uveden√∫ polo≈æku dvakr√°t a t√° sa vr√°ti na miesto.</p>' +
    '<label>Meno ≈æiaka: <input id="studentName" type="text" style="padding:6px;width:300px"></label>';

  sections.forEach(function(s, idx){
    body += '<div class="test-block" data-section="' + idx + '">' +
      '<div class="section-title"><b>√öloha ' + escapeHtml(String(s.id)) + '</b><br><br></div>' +
      '<div class="content" id="content-' + idx + '">' + s.contentHtml + '</div>' +
      '<div class="choices-label">Slov√° na doplnenie:</div>' +
      '<div class="choices" id="choices-' + idx + '">' + s.choicesHtml + '</div>' +
      '<div class="result" id="result-' + idx + '"></div>' +
      '</div>';
  });

  body += '<button id="btnEvaluateAll">Vyhodnoti≈• v≈°etky</button><div id="summary" class="meta"></div>';

  var script = `<script>(function(){
    function codePointLen(s){return Array.from(s||"").length;}
    function escapeHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
    function shuffle(a){var t=a.slice();for(var i=t.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=t[i];t[i]=t[j];t[j]=tmp;}return t;}
    var secData=${JSON.stringify(sections.map(s => ({answers:s.answers})))};

    document.querySelectorAll(".test-block").forEach(function(block,idx){
      var choices = block.querySelector(".choices");
      var selected = null;
      var originalChoices = Array.from(choices.querySelectorAll(".choice")).map(c => c.textContent);
      choices.innerHTML = "";
      shuffle(originalChoices).forEach(function(txt){
        var c = document.createElement("span");
        c.className = "choice";
        c.textContent = txt;
        choices.appendChild(c);
      });

      block.querySelectorAll(".gap").forEach(function(g){
        g.dataset.current = g.dataset.current || "";
        g.addEventListener("click", function(){
          if(selected) selected.classList.remove("selected");
          selected = g;
          g.classList.add("selected");
        });
        g.addEventListener("dblclick", function(){
          var num = g.dataset.gap;
          var cur = g.dataset.current || "";
          if(cur){
            var back = document.createElement("span");
            back.className = "choice";
            back.textContent = cur;
            choices.appendChild(back);
          }
          var clen = Number(g.dataset.correctLen) || 0;
          g.textContent = "_".repeat(clen) + "(" + num + ")";
          g.dataset.current = "";
          g.classList.remove("selected","correct","incorrect");
          selected = null;
        });
      });

      choices.addEventListener("click", function(e){
        var c = e.target.closest(".choice");
        if(!c) return;
        if(!selected){ alert("Najprv kliknite na medzeru."); return; }
        var num = selected.dataset.gap;
        var cur = selected.dataset.current || "";
        if(cur){
          var back = document.createElement("span");
          back.className = "choice";
          back.textContent = cur;
          choices.appendChild(back);
        }
        selected.textContent = c.textContent + "(" + num + ")";
        selected.dataset.current = c.textContent;
        c.remove();
        selected.classList.remove("selected");
        selected = null;
      });
    });

    document.getElementById("btnEvaluateAll").addEventListener("click", function(){
      var sumOk = 0, sumTotal = 0;
      document.querySelectorAll(".test-block").forEach(function(block,idx){
        var answers = secData[idx].answers || {};
        var total = Object.keys(answers).length;
        var ok = 0;
        block.querySelectorAll(".gap").forEach(function(g){
          g.classList.remove("correct","incorrect");
          var num = g.dataset.gap;
          var correct = answers[num] || "";
          var user = g.dataset.current || "";
          var clen = Number(g.dataset.correctLen) || 0;
          var miss = Math.max(0, clen - codePointLen(user));
          g.textContent = (user || "") + "_".repeat(miss) + "(" + num + ")";
          if(user === correct){ g.classList.add("correct"); ok++; }
          else{ g.classList.add("incorrect"); }
        });
        sumOk += ok;
        sumTotal += total;
      });
      var pct = Math.round((sumOk / (sumTotal || 1)) * 100);
      var name = document.getElementById("studentName").value || "";
      var now = new Date();
      document.getElementById("summary").innerHTML =
        "<b>N√°zov testu:</b> " + escapeHtml("${escapeHtml(title)}") +
        "<br><b>Meno ≈æiaka:</b> " + escapeHtml(name) +
        "<br><b>Hodnotenie:</b> " + sumOk + "/" + sumTotal + " (" + pct + "%)" +
        "<br><b>D√°tum a ƒças:</b> " + now.toLocaleString();
    });
  })();<\/script>`;

  return head + body + script + '</body></html>';
}


    function downloadHtml(filename, html){
      var blob = new Blob([html], {type:'text/html;charset=utf-8'});
      var url = URL.createObjectURL(blob);
      var a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); },3000);
    }

    // Z jedn√©ho testu (glob√°lny testArea)
    function createSectionFromSingle(){
      var testArea=document.getElementById('testArea');
      var choicesArea=document.getElementById('choicesArea');
      if(!testArea || !choicesArea) return null;
      if(!testArea.querySelector('.gap')) return null;
      // prid√°me data-current do ka≈æd√©ho gapu (ak ch√Ωba)
      testArea.querySelectorAll('.gap').forEach(function(g){ if(!g.dataset.current) g.dataset.current=''; });
      var contentHtml = testArea.innerHTML;
      var choicesHtml = choicesArea.innerHTML;
      var answers={}; Object.keys(correctAnswers||{}).forEach(function(k){ answers[k]=correctAnswers[k]; });
      return { id:1, contentHtml:contentHtml, choicesHtml:choicesHtml, answers:answers };
    }

    // Z viacer√Ωch √∫loh (tasks[])
    function createSectionsFromTasks(){
      var sections=[];
      tasks.forEach(function(task){
        var div=document.getElementById('task'+task.id);
        if(!div) return;
        if(!task.correctAnswers || Object.keys(task.correctAnswers).length===0) return; // len vygenerovan√©
        var contentEl=div.querySelector('.testContent');
        var choicesEl=div.querySelector('.choicesArea');
        // dopln√≠me data-current do gapov (ak ch√Ωba)
        contentEl.querySelectorAll('.gap').forEach(function(g){ if(!g.dataset.current) g.dataset.current=''; });
        var contentHtml=contentEl.innerHTML;
        var choicesHtml=choicesEl.innerHTML;
        sections.push({ id:task.id, contentHtml:contentHtml, choicesHtml:choicesHtml, answers:task.correctAnswers });
      });
      return sections;
    }

    document.getElementById('btnDownloadSingle').onclick = function(){
      var title = document.getElementById('testTitle').value || 'Cloze_test';
      var section = createSectionFromSingle();
      if(!section){ alert('Najprv vygenerujte test v jedno√∫lohovom re≈æime (Generova≈• test).'); return; }
      var html = buildStandaloneHTML(title, [section]);
      var fname = title.trim().replace(/\s+/g,'_')+'.html';
      downloadHtml(fname, html);
    };

    document.getElementById('btnDownloadAll').onclick = function(){
      var title = document.getElementById('testTitle').value || 'Cloze_test_multi';
      var sections = createSectionsFromTasks();
      if(!sections.length){ alert('Najprv vygenerujte testy pre jednotliv√© √∫lohy (Generova≈• test v ka≈ædom paneli).'); return; }
      var html = buildStandaloneHTML(title, sections);
      var fname = title.trim().replace(/\s+/g,'_')+'_multi.html';
      downloadHtml(fname, html);
    };

    // Whitespace-cleaning functions (p√¥vodn√©)
    function cleanWhitespace(){
      var ta=document.getElementById('inputText'); var t=ta.value.replace(/\r\n?/g,"\n").replace(/\u00A0/g," ").replace(/\t/g," ");
      var paragraphs=t.split(/\n\s*\n+/).map(function(p){
        return p.split("\n").map(function(line){ return line.replace(/\s+/g," ").trim(); }).filter(Boolean).join(" ");
      }).filter(Boolean);
      t=paragraphs.join("\n\n"); t=t.replace(/\s+([,.?!])/g,"$1"); ta.value=t;
    }
    function fixCommas(){ var ta=document.getElementById('inputText'); var t=ta.value; t=t.replace(/\s+,/g,","); t=t.replace(/,(?!\s)/g,", "); t=t.replace(/, +/g,", "); ta.value=t; }
    function fixPunctuation(){ var ta=document.getElementById('inputText'); var t=ta.value; t=t.replace(/\s+([.!?])/g,"$1"); t=t.replace(/([.!?])(?!\s|$)/g,"$1 "); t=t.replace(/([.!?]) +/g,"$1 "); ta.value=t; }
    function fixQuotes(){ var ta=document.getElementById('inputText'); var t=ta.value; t=t.replace(/[\u00A0\u2009\u202F\u2002-\u2008]/g," "); t=t.replace(/([‚Äû‚Äú])\s+/g,"$1"); t=t.replace(/([^\s])([‚Äû‚Äú])/g,"$1 $2"); t=t.replace(/([‚Äù"])([^\s])/g,"$1 $2"); t=t.replace(/([‚Äù"])\s*([‚Äû‚Äú])/g,"$1 $2"); t=t.replace(/ {2,}/g," "); t=t.replace(/([.,!?;:])\s+([‚Äù"])/g,"$1$2"); ta.value=t; }
    function copyToClipboard(){ var ta=document.getElementById('inputText'); ta.select(); ta.setSelectionRange(0,99999); document.execCommand('copy'); alert('Text bol skop√≠rovan√Ω do schr√°nky.'); }

    document.getElementById('btnClean').addEventListener('click', cleanWhitespace);
    document.getElementById('btnFixCommas').addEventListener('click', fixCommas);
    document.getElementById('btnFixPunctuation').addEventListener('click', fixPunctuation);
    document.getElementById('btnFixQuotes').addEventListener('click', fixQuotes);
    document.getElementById('btnCopy').addEventListener('click', copyToClipboard);
	
	// --- LocalStorage pre vstupn√Ω text a n√°zov testu ---
const inputTextEl = document.getElementById('inputText');
const testTitleEl = document.getElementById('testTitle');

// pri naƒç√≠tan√≠ str√°nky obnov√≠me ulo≈æen√© hodnoty
window.addEventListener('DOMContentLoaded', () => {
  const savedText = localStorage.getItem('cloze_inputText');
  const savedTitle = localStorage.getItem('cloze_testTitle');
  if (savedText !== null) inputTextEl.value = savedText;
  if (savedTitle !== null) testTitleEl.value = savedTitle;
});

// pri zmene obsahu ulo≈æ√≠me do localStorage
inputTextEl.addEventListener('input', () => {
  localStorage.setItem('cloze_inputText', inputTextEl.value);
});
testTitleEl.addEventListener('input', () => {
  localStorage.setItem('cloze_testTitle', testTitleEl.value);
});

  </script>

<br><br>
  <b>Spracovala pomocou UI:</b> Mgr. Erika Matyiov√° (2025)
<br><br>
</body>
</html>