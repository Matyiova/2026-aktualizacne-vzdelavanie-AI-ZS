<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <title>TTS s ulo≈æen√≠m hlasu/jazyka</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Courier bold, monospace; line-height: 1.5; padding: 16px; max-width: 900px; margin: 0 auto; }
    textarea { width: 100%; min-height: 200px; }
    .row { margin: 10px 0; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    label { font-weight: 600; }
    select, input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 8px 12px; border: 1px solid #bbb; border-radius: 8px; background: #f6f6f6; cursor: pointer; }
    button:hover { background: #eee; }
  </style>
</head>
<body>
  <h2>Text na predƒç√≠tanie</h2>

  <div class="row">
    <textarea id="text" placeholder="Sem vlo≈æ text."></textarea>
  </div>

  <div class="row">
    <label for="languageSearch">üîç Hƒæadaj hlas/jazyk:</label>
    <input id="languageSearch" type="text" placeholder="napr. sk, en-US, German, ru, fr..." />
  </div>

  <div class="row">
    <label for="voiceSelect">üîä Hlas:</label>
    <select id="voiceSelect"></select>
  </div>

  <div class="row">
    <label for="rateSelect">üîÑ R√Ωchlos≈•:</label>
    <select id="rateSelect">
	  <option value="0.7">0.7√ó</option>
      <option value="0.8">0.8√ó</option>
      <option value="0.9">0.9√ó</option>
      <option value="1" selected>1√ó</option>
      <option value="1.2">1.2√ó</option>
      <option value="1.5">1.5√ó</option>
    </select>
	</div>
	
<div class="row">
    <label for="pitchRange">üéµ V√Ω≈°ka: <span id="pitchValue">1</span></label>
    <input id="pitchRange" type="range" min="0" max="2" step="0.1" value="1" />
</div>

<div class="row">
    <label for="pauseTitle">‚è∏Ô∏è Pauza po nadpise (ms):</label>
    <input id="pauseTitle" type="number" value="800" min="0" step="100" />
    <label for="pauseSentence">‚è∏Ô∏è Pauza po vete (ms):</label>
    <input id="pauseSentence" type="number" value="400" min="0" step="100" />
  </div>

  <div class="row">
    <button id="btnSpeak">‚ñ∂Ô∏è Spusti≈•</button>
    <button id="btnSpeakFromCursor">‚ñ∂Ô∏è Od kurzora</button>
    <button id="btnStop">‚èπÔ∏è Stop</button>
    <button id="btnClean">üßº Vyƒçisti≈• medzery v texte</button>
    <button id="btnSave">üíæ Ulo≈æi≈• ako HTML</button>
  </div>

 <script>
  let voices = [];
  let allVoiceOptions = [];
  let voicesReady = false;

  const LS_KEYS = {
    text: "savedText",
    rate: "rate",
    voiceURI: "voiceURI",
    voiceLang: "voiceLang"
  };

  let lastSelStart = 0;
  let lastSelEnd = 0;

  // Helper: get currently selected voice
  function getSelectedVoice() {
    const select = document.getElementById("voiceSelect");
    const idx = Number(select.value);
    return voices[idx] || null;
  }

  // Helper: persist voiceURI + lang
  function persistCurrentVoice() {
    const v = getSelectedVoice();
    if (v && v.voiceURI && v.lang) {
      localStorage.setItem(LS_KEYS.voiceURI, v.voiceURI);
      localStorage.setItem(LS_KEYS.voiceLang, v.lang);
    }
  }

  window.addEventListener("load", () => {
    const savedText = localStorage.getItem(LS_KEYS.text);
    if (savedText !== null) document.getElementById("text").value = savedText;

    const savedRate = localStorage.getItem(LS_KEYS.rate);
    if (savedRate !== null) document.getElementById("rateSelect").value = savedRate;

    initVoices();
    updatePitchLabel();
  });

  document.getElementById("text").addEventListener("input", e => {
    localStorage.setItem(LS_KEYS.text, e.target.value);
  });

  document.getElementById("rateSelect").addEventListener("change", e => {
    localStorage.setItem(LS_KEYS.rate, e.target.value);
  });

  document.getElementById("voiceSelect").addEventListener("change", () => {
    persistCurrentVoice();
  });

  function updatePitchLabel() {
    document.getElementById("pitchValue").textContent =
      document.getElementById("pitchRange").value;
  }

  function populateVoiceList() {
    const voiceSelect = document.getElementById("voiceSelect");
    const savedURI = localStorage.getItem(LS_KEYS.voiceURI);
    const savedLang = localStorage.getItem(LS_KEYS.voiceLang);

    voices = speechSynthesis.getVoices() || [];
    allVoiceOptions = [];
    voiceSelect.innerHTML = "";

    voices.forEach((voice, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `${voice.name} (${voice.lang})${voice.default ? " ‚Äî default" : ""}`;
      opt.dataset.voiceuri = voice.voiceURI;
      opt.dataset.lang = voice.lang;
      allVoiceOptions.push(opt);
      voiceSelect.appendChild(opt);
    });

    let targetIndex = -1;
    if (savedURI) {
      targetIndex = voices.findIndex(v => v.voiceURI === savedURI);
    }
    if (targetIndex < 0 && savedLang) {
      targetIndex = voices.findIndex(v => v.lang === savedLang);
    }
    if (targetIndex < 0) {
      const def = voices.findIndex(v => v.default);
      targetIndex = def >= 0 ? def : (voices.length > 0 ? 0 : -1);
    }

    if (targetIndex >= 0) {
      voiceSelect.value = String(targetIndex);
      persistCurrentVoice();
    }

    voicesReady = voices.length > 0;
  }

  function initVoices() {
    populateVoiceList();
    if (!voicesReady) {
      window.speechSynthesis.onvoiceschanged = populateVoiceList;
      let tries = 0;
      const interval = setInterval(() => {
        tries++;
        populateVoiceList();
        if (voicesReady || tries > 10) clearInterval(interval);
      }, 300);
    }
  }

  function filterVoices() {
    const q = document.getElementById("languageSearch").value.toLowerCase();
    const voiceSelect = document.getElementById("voiceSelect");
    const savedURI = localStorage.getItem(LS_KEYS.voiceURI);

    voiceSelect.innerHTML = "";
    let restored = false;

    allVoiceOptions.forEach(opt => {
      if (opt.textContent.toLowerCase().includes(q)) {
        const clone = opt.cloneNode(true);
        voiceSelect.appendChild(clone);
        if (!restored && savedURI && opt.dataset.voiceuri === savedURI) {
          voiceSelect.value = clone.value;
          restored = true;
        }
      }
    });

    if (!restored && voiceSelect.options.length > 0) {
      voiceSelect.selectedIndex = 0;
    }

    persistCurrentVoice();
  }

  function splitTextIntoChunks(text) {
    return text.split(/(?<=[.?!])\s+|\n+/).filter(p => p.trim().length > 0);
  }

  function speak() {
    const text = document.getElementById("text").value.trim();
    if (!text) return;

    const chunks = splitTextIntoChunks(text);
    const pauseTitle = parseInt(document.getElementById("pauseTitle").value) || 1000;
    const pauseSentence = parseInt(document.getElementById("pauseSentence").value) || 400;

    const rate = parseFloat(document.getElementById("rateSelect").value);
    const pitch = parseFloat(document.getElementById("pitchRange").value);
    const voice = getSelectedVoice();

    let index = 0;
    function speakChunk() {
      if (index >= chunks.length) return;
      const u = new SpeechSynthesisUtterance(chunks[index]);
      u.rate = rate;
      u.pitch = pitch;
      if (voice) {
        u.voice = voice;
        u.lang = voice.lang;
      }
      u.onend = () => {
        index++;
        const pause = index === 1 ? pauseTitle : pauseSentence;
        setTimeout(speakChunk, pause);
      };
      speechSynthesis.speak(u);
    }

    speechSynthesis.cancel();
    speakChunk();
  }

  function speakFromCursor() {
    const ta = document.getElementById("text");
    const isActive = document.activeElement === ta;
    const start = isActive ? ta.selectionStart : lastSelStart;
    const end = isActive ? ta.selectionEnd : lastSelEnd;

    const segment = end > start ? ta.value.slice(start, end) : ta.value.slice(start);
    if (!segment.trim()) return;

    const chunks = splitTextIntoChunks(segment);
    const pauseSentence = parseInt(document.getElementById("pauseSentence").value) || 400;
    const rate = parseFloat(document.getElementById("rateSelect").value);
    const pitch = parseFloat(document.getElementById("pitchRange").value);
    const voice = getSelectedVoice();

    let index = 0;
    function speakChunk() {
      if (index >= chunks.length) return;
      const u = new SpeechSynthesisUtterance(chunks[index]);
      u.rate = rate;
      u.pitch = pitch;
      if (voice) {
        u.voice = voice;
        u.lang = voice.lang;
      }
      u.onend = () => {
        index++;
        setTimeout(speakChunk, pauseSentence);
      };
      speechSynthesis.speak(u);
    }

    speechSynthesis.cancel();
    speakChunk();
  }

  function stopSpeaking() {
    speechSynthesis.cancel();
  }

  function cleanText() {
    const ta = document.getElementById("text");
    ta.value = ta.value
      .replace(/[ \t]+/g, " ")
      .replace(/\n{3,}/g, "\n\n");
    localStorage.setItem(LS_KEYS.text, ta.value);
  }

 // --- Ulo≈æenie ako HTML ---
    function saveAsHTML() {
      const safeText = document.getElementById("text").value;
      const voiceIndex = document.getElementById("voiceSelect").value;
      const voice = voices[Number(voiceIndex)];
      const selectedLang = (voice && voice.lang) || "sk-SK";

      function escapeHTML(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      const htmlContent = `
<!DOCTYPE html>
<html lang="${selectedLang}">
<head>
  <meta charset="UTF-8">
  <title>Ulo≈æen√Ω text</title>
  <style>
    body { font-family: system-ui, Courier bold, monospace; padding: 20px; }
    #text { white-space: pre-wrap; margin-bottom: 1em; }
    button, select { margin: 0.3em; padding: 0.4em 0.8em; }
    .highlight { background-color: yellow; }
  </style>
</head>
<body>
  <div id="text">${escapeHTML(safeText)}</div>

  <div>
    <label for="rateSelect">üîÑ R√Ωchlos≈•: </label>
    <select id="rateSelect">
      <option value="0.7">0.7√ó</option>
	  <option value="0.8">0.8√ó</option>
      <option value="0.9">0.9√ó</option>
      <option value="1" selected>1√ó (norm√°lna)</option>
      <option value="1.2">1.2√ó</option>
      <option value="1.5">1.5√ó</option>
    </select>
  </div>

  <button onclick="speak()">‚ñ∂Ô∏è Spusti≈•</button>
  <button onclick="stopSpeaking()">‚èπÔ∏è Zastavi≈•</button>

  <script>
    const selectedLang = "${selectedLang}";

    // --- LocalStorage pre r√Ωchlos≈• ---
    window.addEventListener("load", () => {
      const savedRate = localStorage.getItem("rate");
      if (savedRate) {
        document.getElementById("rateSelect").value = savedRate;
      }
    });
    document.getElementById("rateSelect").addEventListener("change", e => {
      localStorage.setItem("rate", e.target.value);
    });

    function splitTextIntoChunks(text) {
      return text.split(/(?<=[.?!])\\s+|\\n{2,}/).filter(p => p.trim().length > 0);
    }

    function prepareChunks() {
      const container = document.getElementById("text");
      const rawText = container.textContent;
      const chunks = splitTextIntoChunks(rawText);

      container.innerHTML = "";
      chunks.forEach((chunk, i) => {
        const span = document.createElement("span");
        span.textContent = chunk + " ";
        span.id = "chunk-" + i;
        container.appendChild(span);
      });
      return chunks;
    }

    function speak() {
      const chunks = prepareChunks();
      const rate = parseFloat(document.getElementById("rateSelect").value);

      let index = 0;
      function speakChunk() {
        if (index >= chunks.length) return;
        const u = new SpeechSynthesisUtterance(chunks[index]);
        u.rate = rate;
        u.lang = selectedLang || "sk-SK";

        u.onstart = () => {
          document.querySelectorAll(".highlight").forEach(el => el.classList.remove("highlight"));
          const el = document.getElementById("chunk-" + index);
          if (el) el.classList.add("highlight");
        };

        let pause = /[.?!]$/.test(chunks[index]) ? 600 : 800;
        u.onend = () => { index++; setTimeout(speakChunk, pause); };
        speechSynthesis.speak(u);
      }

      speechSynthesis.cancel();
      speakChunk();
    }

    function stopSpeaking() {
      speechSynthesis.cancel();
      document.querySelectorAll(".highlight").forEach(el => el.classList.remove("highlight"));
    }
  <\/script>
</body>
</html>
`;
    const blob = new Blob([htmlContent], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ulozeny_text.html";
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  // event listeners
  document.getElementById("btnSpeak").addEventListener("click", speak);
  document.getElementById("btnSpeakFromCursor").addEventListener("click", speakFromCursor);
  document.getElementById("btnStop").addEventListener("click", stopSpeaking);
  document.getElementById("btnClean").addEventListener("click", cleanText);
  document.getElementById("btnSave").addEventListener("click", saveAsHTML);
  document.getElementById("languageSearch").addEventListener("input", filterVoices);
  document.getElementById("pitchRange").addEventListener("input", updatePitchLabel);

  initVoices();
</script>
<br><br>
  <b>Spracovala pomocou UI:</b> Mgr. Erika Matyiov√° (2025)
<br><br>
</body>
</html>